<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- Add Bootstrap CDN link or download and include the Bootstrap CSS file -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container mt-4">
      <h2 class="mb-4">Historial De Transacciones</h2>
      <div class="table-responsive">
        <div class="row mb-3">
          <div class="col">
            <button id="sort-asc-btn" class="btn btn-secondary mt-4">
              Ordenar Ascendente
            </button>
            <button id="sort-desc-btn" class="btn btn-secondary mt-4">
              Ordenar Descendente
            </button>
          </div>
          <div class="col">
            <label for="startDate" class="form-label">Fecha de inicio:</label>
            <input type="date" class="form-control" id="startDate" />
          </div>
          <div class="col">
            <label for="endDate" class="form-label">Fecha de fin:</label>
            <input type="date" class="form-control" id="endDate" />
          </div>
          <div class="col">
            <button id="filter-btn" class="btn btn-success mt-4">
              Filtrar
            </button>
          </div>
        </div>

        <button id="download-pdf" class="btn btn-primary my-2">
          Descargar PDF
        </button>

        <table class="table table-bordered" id="transaction-table">
          <thead class="table-dark">
            <tr>
              <th>Transaction ID</th>
              <th>Date</th>
              <th>Transaction Type</th>
              <th>From Account</th>
              <th>To Account</th>
              <th>Amount</th>
              <th>Concept</th>
              <th>Account ID</th>
            </tr>
          </thead>
          <tbody>
            <% historial.forEach(transaction => { %>
            <tr>
              <td><%= transaction.transaccion_id %></td>
              <td>
                <%= transaction.fechadetransaccion.toISOString().split('T')[0]
                %>
              </td>
              <td><%= transaction.tipodemovimiento %></td>
              <td><%= transaction.cuentaorigen %></td>
              <td><%= transaction.cuentadestino %></td>
              <!-- Apply conditional classes based on transaction type -->
              <td
                class="<%= transaction.tipodemovimiento === 'Deposito' ? 'text-success' : 'text-danger' %>"
              >
                <%= transaction.monto %>
              </td>
              <td><%= transaction.concepto %></td>
              <td><%= transaction.cuenta_id %></td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Bootstrap JS and Popper.js if needed -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://rawgit.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>

    <script>
      $(document).ready(function () {
        // Agrega un evento de clic al botón de descarga
        $("#download-pdf").on("click", function () {
          // Convierte el contenido de la tabla a PDF
          var element = document.getElementById("transaction-table");
          html2pdf(element);
        });

        // Agrega un evento de clic al botón de filtrar
        $("#filter-btn").on("click", function () {
          // Obtiene las fechas de inicio y fin
          var startDate = $("#startDate").val();
          var endDate = $("#endDate").val();

          // Filtra las transacciones por fecha
          filterTransactionsByDate(startDate, endDate);
        });
      });

      function filterTransactionsByDate(startDate, endDate) {
        // Obtén todas las filas de la tabla
        var rows = $("#transaction-table tbody tr");

        // Itera sobre las filas y muestra u oculta según el rango de fechas
        rows.each(function () {
          var transactionDate = $(this).find("td:nth-child(2)").text(); // La fecha está en la segunda columna

          // Compara la fecha de la transacción con el rango seleccionado
          if (isDateInRange(transactionDate, startDate, endDate)) {
            $(this).show();
          } else {
            $(this).hide();
          }
        });
      }

      $("#sort-asc-btn").on("click", function () {
        sortTransactionsByAmount("asc");
      });

      // Agrega un evento de clic al botón de ordenar descendente
      $("#sort-desc-btn").on("click", function () {
        sortTransactionsByAmount("desc");
      });

      function isDateInRange(date, startDate, endDate) {
        // Convierte las fechas a objetos de fecha
        var transactionDate = new Date(date);
        var start = new Date(startDate);
        var end = new Date(endDate);

        // Verifica si la fecha de la transacción está en el rango
        return transactionDate >= start && transactionDate <= end;
      }

      function sortTransactionsByAmount(order) {
        // Obtén todas las filas de la tabla
        var rows = $("#transaction-table tbody tr");

        // Ordena las filas según el monto
        rows.sort(function (a, b) {
          var amountA = parseFloat($(a).find("td:nth-child(6)").text()); // El monto está en la sexta columna
          var amountB = parseFloat($(b).find("td:nth-child(6)").text());

          if (order === "asc") {
            return amountA - amountB;
          } else {
            return amountB - amountA;
          }
        });

        // Elimina todas las filas de la tabla
        $("#transaction-table tbody").empty();

        // Agrega las filas ordenadas de nuevo a la tabla
        $("#transaction-table tbody").append(rows);
      }
    </script>
  </body>
</html>
